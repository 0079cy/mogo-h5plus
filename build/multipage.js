const fs = require("fs");
const HtmlWebpackPlugin = require("html-webpack-plugin");

// 通过路径生成页面路径json
function generateByPath() {
  const reg = /\.\S+$/;
  let pagesPath = {};
  fs.readdirSync("./src/page")
    .filter(filename => !reg.test(filename))
    .map(filename => {
      const jsReg = /\.js$/;
      const pagePath = fs
        .readdirSync("./src/page/" + filename)
        .filter(filename => jsReg.test(filename));
      pagePath.map(name => {
        pagesPath[filename + "/" + name.replace(".js", "")] =
          "./src/page/" + filename + "/" + name;
      });
    });
  return pagesPath;
}
// 通过页面配置文件过去页面json
function generateByConfig() {
  return JSON.parse(fs.readFileSync("./src/page.json"));
}

// 生成extraEntry 如果有配置就使用配置,没有配置就读取文件,目的在于兼容0.2版本
let extraEntry = {};
try {
  extraEntry = generateByConfig();
  console.log("extraEntry generated by page.json");
} catch (e) {
  extraEntry = generateByPath();
  console.log("extraEntry generated by scan page folder");
}

// 生成HtmlWebpackPlugin
let extraHtmlWebpackPlugins = [];
for (let i in extraEntry) {
  extraHtmlWebpackPlugins.push(
    new HtmlWebpackPlugin({
      filename: i + ".html",
      template: "index.html",
      chunks: [i],
      muiSourcePath: "../"
    })
  );
}

exports.extraEntry = extraEntry;
exports.extraHtmlWebpackPlugins = extraHtmlWebpackPlugins;
